<?xml version="1.0"?>

<project name="annotation-file-utilities" default="zipfile">
  <description>
     Ant build file for the annotation file utilities.
     Run "ant -projecthelp" for a full list of options.
  </description>

  <property environment="env"/>

  <property name="java-version" value="7"/>

  <!-- for distribution version:
  <property name="asmx" value="./asmx"/>
  <property name="annotations-compiler" value="./lib"/>
  <property name="scene-lib" value="./scene-lib"/>
  <property name="annotator" value="./annotator"/>
  <property name="workspace" value="."/>
  -->

  <!-- Can't I just reuse temp-annotation-file-utilities, rather than
       having this separate directory? -->
  <property name="temp-jarfile" value="${java.io.tmpdir}/annotation-file-utilities-jarfile" />

<!--
  <property name="jsr308-www"
    value="/afs/csail/group/pag/www/jsr308"/>
-->
  <property name="jsr308-www"
    value="/cse/www2/types"/>
  <property name="jsr308-www-annotation-file-utilities"
    value="${jsr308-www}/annotation-file-utilities"/>

  <target name="init-properties">
    <condition property="exists.build.properties">
      <available file="build.properties"/>
    </condition>
    <fail
      unless="exists.build.properties"
      message="Local build.properites file is missing."/>

    <property file="build.properties"/>

    <fail
      unless="global.build.properties"
      message="Local build.properties file did not define global buildfile in property global.build.properties"/>
    <condition property="exists.global.build.properties">
      <available file="${global.build.properties}"/>
    </condition>
    <fail
      unless="exists.global.build.properties"
      message="File ${global.build.properties} file not found."/>
    <property file="${global.build.properties}"/>

    <fail
      unless="user.build.properties"
      message="Local build.properties file did not define global buildfile in property user.build.properties"/>
    <condition property="exists.user.build.properties">
      <available file="${user.build.properties}"/>
    </condition>
    <fail
      unless="exists.user.build.properties"
      message="File ${user.build.properties} file not found."/>
    <property file="${user.build.properties}"/>
  </target>

  <!-- Compiles all the subparts of the Annotation File Utilities. -->
  <target name="init-dependencies"
          depends="init-properties">
      <ant dir="${asmx}" target="bin">
        <property name="product.noshrink" value="true"/>
      </ant>
      <ant dir="${scene-lib}" target="bin"/>
      <!-- repository version only: -->
      <!-- I don't see the need for this. -->
      <!-- <ant dir="${annotations-compiler}" antfile="make/build.xml" target="build"/> -->
  </target>

  <target name="init"
          depends="init-properties, init-dependencies">
    <fileset dir="src" id="src-files">
      <include name="**/*.java"/>
    </fileset>

    <path id="libpath">
      <!-- alternate for distribution:
      <pathelement location="${annotations-compiler}/bin"/>
      -->
      <pathelement location="${annotations-compiler}/dist/lib/javac.jar"/>
      <pathelement location="${annotation-tools}/annotation-file-utilities/lib/utilMDE.jar"/>
      <pathelement location="${scene-lib}/bin"/>
      <pathelement location="${asmx}/bin"/>
      <!-- additional for distribution:
      <pathelement location="${jre1.6.0}"/>
      -->
    </path>
  </target>

  <!-- Copy files from repository to temporary directory from which they will be
  packaged up. -->
  <target name="update-workspace" depends="init-properties">
    <delete dir="${temp-annotation-file-utilities}" />
    <mkdir dir="${temp-annotation-file-utilities}" />

    <copy todir="${temp-annotation-file-utilities}">
      <fileset dir=".">
        <include name="build.xml"/>
        <include name="**/src/**"/>
        <include name="**/scripts/**"/>
        <include name="**/lib/**"/>
        <include name="**/test/**"/>
        <include name="**/tests/**"/>
        <exclude name="**/.svn/**"/>
      </fileset>
    </copy>

    <copy todir="${temp-annotation-file-utilities}/asmx">
      <fileset dir="${asmx}">
	<include name="build.xml"/>
        <include name="*.jar"/>
        <include name="./build.*"/>
        <include name="**/src/**"/>
        <include name="**/core/**"/>
        <include name="**/config/**"/>
        <exclude name="**/.svn/**"/>
      </fileset>
    </copy>

    <copy todir="${temp-annotation-file-utilities}/scene-lib">
      <fileset dir="${scene-lib}">
        <include name="build.xml"/>
        <include name="**/src**"/>
        <exclude name="**/.svn/**"/>
      </fileset>
    </copy>

  </target>

  <target name="jarfile"
          depends="init,clean,build"
          description="create the class library annotation-file-utilities.jar">

    <echo message="Using temporary directory: ${temp-jarfile}"/>
    <mkdir dir="${temp-jarfile}"/>

    <echo message="Copying .class files to ${temp-jarfile}"/>
    <copy todir="${temp-jarfile}">
      <fileset dir="bin" />
      <fileset dir="${asmx}/bin" excludes="tmp/**"/>
      <fileset dir="${scene-lib}/bin" />
      <fileset dir="${annotations-compiler}/build/classes" />
      <fileset dir="${annotations-compiler}/build/bootstrap"/>
    </copy>
    <!-- Also need to get class files in libraries -->
    <unjar src="lib/utilMDE.jar" dest="${temp-jarfile}">
      <patternset>
        <include name="**/*.class"/>
        <exclude name="META-INF/" />
      </patternset>
    </unjar>

    <!-- Actually create a single .jar file of all the class files,
         scripts and documentation -->
    <echo message="Creating jarfile annotation-file-utilities.jar"/>
    <jar destfile="annotation-file-utilities.jar">
      <fileset dir="${temp-jarfile}"/>
    </jar>

    <!-- Delete class files copied over -->
    <echo message="Deleting temporary directory: ${temp-jarfile}"/>
    <delete>
      <fileset dir="${temp-jarfile}"/>
    </delete>
  </target>

  <target name="zipfile"
          depends="jarfile,run-tests,update-workspace,annotation-file-format"
          description="create the distribution: annotation-file-utilities.zip">
    <!-- Create a new directory containing all the files and then zip that
         directory, so that when the user unzips they extract exactly one
         directory. -->
    <!-- Copy all files from workspace, plus a few other files. -->
    <copy todir="${temp-annotation-file-utilities}">
      <fileset dir=".">
        <include name="$/"/>
        <exclude name="**/.svn/*"/>
      </fileset>
      <fileset file="annotation-file-utilities.jar"/>
      <fileset dir="scripts" excludes="**/.svn/*"/>
      <fileset file="annotation-file-utilities.html"/>
      <fileset file="annotation-file-format.pdf"/>
      <fileset file="annotation-file-format.html"/>
    </copy>

    <!-- In order for the shell scripts to have the proper execution bit set,
         include them specifically with the right permissions.  Ant presently
         does not use the file's permissions themselves to do this. -->
    <zip destfile="annotation-file-utilities.zip" compress="true">
      <fileset dir="${java.io.tmpdir}">
        <include name="annotation-file-utilities/"/>
        <exclude name="annotation-file-utilities/extract-annotations"/>
        <exclude name="annotation-file-utilities/insert-annotations"/>
        <exclude name="annotation-file-utilities/insert-annotations-to-source"/>
      </fileset>
      <zipfileset dir="${java.io.tmpdir}" filemode="755">
        <include name="annotation-file-utilities/extract-annotations"/>
        <include name="annotation-file-utilities/insert-annotations"/>
        <include name="annotation-file-utilities/insert-annotations-to-source"/>
      </zipfileset>
    </zip>

    <!-- Delete temporary files once they have been zipped. -->
    <delete dir="${temp-annotation-file-utilities}"/>
  </target>

   <target name="export" depends="clean,zipfile"
          description="export the zipfile, etc. to its website">
    <echo message="Export location: ${jsr308-www-annotation-file-utilities}"/>
    <echo message="Copying annotation-file-utilities.zip"/>
    <copy file="annotation-file-utilities.zip"
      todir="${jsr308-www-annotation-file-utilities}"/>

    <echo message="Copying annotation-file-utilities.html as index.html"/>
    <copy file="annotation-file-utilities.html"
      tofile="${jsr308-www-annotation-file-utilities}/index.html"/>

    <echo message="Copying annotation-file-format.{html,pdf"/>
    <copy file="annotation-file-format.html"
      todir="${jsr308-www-annotation-file-utilities}"/>
    <copy file="annotation-file-format.pdf"
      todir="${jsr308-www-annotation-file-utilities}"/>

    <echo message="Updating link dates"/>
<!--
  TEMPORARY
-->
<!--
    <exec executable="update-link-dates"
          failonerror="true">
      <arg value="${jsr308-www}/jsr308-webpage.html"/>
    </exec>
    <echo message="Checking HTML links"/>
    <exec executable="/usr/bin/make"
          failonerror="true">
      <arg value="-C"/>
      <arg value="../doc"/>
      <arg value="checklinks"/>
    </exec>
-->

  </target>

  <!--
    A problem is that the document date is the date that LaTeX was run
    rather than the date of last modification; that should be fixed in
    the document, perhaps.  -->
  <target name="annotation-file-format"
          description="Make documentation: annotation-file-format.{html,pdf}">
    <exec executable="latex">
      <arg value="annotation-file-format.tex"/>
    </exec>
    <exec executable="pdflatex">
      <arg value="annotation-file-format.tex"/>
    </exec>
    <exec executable="hevea">
      <arg value="urlhref.hva"/>
      <arg value="annotation-file-format.tex"/>
    </exec>
  </target>

  <target name="clean"
          description="removes generated files (e.g., .jar, .zip)">
    <delete dir="bin"/>

    <!-- <echo message="Deleting temporary directory: ${temp-jarfile}"/> -->
    <delete dir="${temp-jarfile}"/>
    <delete dir="${temp-annotation-file-utilities}"/>

    <!-- <echo message="Deleting previous distribution:  annotation-file-utilities.{jar,zip}"/> -->
    <delete file="annotation-file-utilities.jar"/>
    <delete file="annotation-file-utilities.zip"/>
  </target>

  <target name="run-tests" description="run tests for the annotator">
    <exec dir="tests/" executable="make" failonerror="true">
    </exec>
  </target>

  <target name="bin"
          depends="build"/>

  <target name="build"
          depends="init"
          description="compile all source files">

    <mkdir dir="bin"/>

    <javac srcdir="src" destdir="bin" debug="true" encoding="8859_1">
      <classpath refid="libpath"/>
    </javac>

  </target>

  <!-- This tags table includes the scene library. -->
  <target name="etags" depends="tags">
  </target>
  <target name="tags"
          description="create Emacs TAGS table, including scene library files">
    <exec executable="/bin/sh">
      <arg value="-c"/>
      <arg value="etags `find src -name '*.java' | sort-directory-order.pl` `find ../scene-lib -name '*.java' | sort-directory-order.pl`"/>
    </exec>
  </target>

</project>
