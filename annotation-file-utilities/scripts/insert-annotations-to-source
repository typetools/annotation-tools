#!/bin/sh

# Insert annotations (from an annotation file) into a Java source file.
# For usage information, run: insert-annotations-to-source --help
# See the Annotation File Utilities documentation for more information.

# A few options are consumed by this script rather than being passed to the
# underlying Java program.  They must be the first command-line arguments
# provided.
DEBUG=1
CLASSPATH=${CLASSPATH}
while [ "$#" -gt 0 ]; do
  case "$1" in
    --debug-script)
      # Debug this script
      DEBUG=1
      shift
      ;;
    -cp|-classpath)
      # Set the classpath
      CLASSPATH=$2
      shift 2
      ;;
    *)
      break
      ;;
  esac
done

AFU=${AFU:-$(dirname $0)/..}
AFU=`cd \`dirname $0\`/.. && pwd`
ANNOTATION_FILE_UTILS=${ANNOTATION_FILE_UTILS:-${AFU}/bin:${AFU}/../scene-lib/bin:${AFU}/../asmx/bin:${AFU}/annotation-file-utilities-all.jar}
JAVAC_JAR=${JAVAC_JAR:-${AFU}/lib/javac-9-dev-r4023-3.jar}

JAVA_VERSION=`java -version 2>&1 | head -1 | cut -d'"' -f2 | sed '/^1\./s///' | cut -d'.' -f1`
if [ "$JAVA_VERSION" = "8" ]; then
  # -Xbootclasspth isn't supported in 9+ and isn't required.
  BOOTCLASSPATH=-Xbootclasspath/p:${JAVAC_JAR}
fi

if [ "$DEBUG" = "1" ]; then
  echo "--- start of insert-annotations-to-source debugging output"
  echo "AFU=${AFU}"
  echo "ANNOTATION_FILE_UTILS=${ANNOTATION_FILE_UTILS}"
  echo "LANGTOOLS=${LANGTOOLS}"
  echo "JAVAC_JAR=${JAVAC_JAR}"
  echo "JAVA_VERSION=${JAVA_VERSION}"
  # Keep this in sync with the actual command below.
  echo java -ea -Xmx512m ${BOOTCLASSPATH} -classpath ${JAVAC_JAR}:${ANNOTATION_FILE_UTILS}:${CLASSPATH} annotator.Main "$@"
  echo "--- end of insert-annotations-to-source debugging output"
fi

# Augment, don't replace, CLASSPATH, so as to find user files.
java -ea -Xmx512m ${BOOTCLASSPATH} -classpath ${JAVAC_JAR}:${ANNOTATION_FILE_UTILS}:${CLASSPATH} annotator.Main "$@"
